# Mapeamento e navegação

Esta seção da documentação concentra-se no processo essencial que permite a um robô mover-se autonomamente em um ambiente desconhecido. Primeiramente, abordaremos como o robô cria um mapa do ambiente ao seu redor, identificando obstáculos e rotas possíveis. Em seguida, discutiremos a importância de uma interface de comunicação eficaz que permite aos usuários especificar pontos para onde desejam que o robô se mova. Essa interface organiza esses pontos em uma sequência lógica e os transmite ao robô na ordem correta. Este fluxo integrado de mapeamento e comunicação é vital para a autonomia do robô. Abaixo, forneceremos detalhes mais aprofundados sobre cada etapa desse processo, explicando como cada componente contribui para a operação autônoma eficaz do robô.

## Tecnologias

A integração do ROS 2 (Robot Operating System 2), NAV2 (Navigation Stack 2) e TurtleBot3 desempenha um papel central em nossa arquitetura de projeto para sistemas de AMR (Autonomous Mobile Robots), especialmente relevantes para a implementação de navegação autônoma em ambientes industriais. O ROS 2, como sistema operacional para robôs, oferece uma base robusta para o desenvolvimento, enquanto o NAV2, parte integrante do ecossistema ROS 2, fornece recursos avançados de navegação, incluindo algoritmos de mapeamento, localização e planejamento de trajetória.

Nesse contexto, o TurtleBot3, modular e flexível, se conecta ao ROS 2 e NAV2, proporcionando uma plataforma pronta para aplicação prática. Este conjunto de tecnologias possibilita a criação de soluções autônomas e eficientes para robôs de entrega de ferramentas em ambientes industriais. O TurtleBot3, ao se beneficiar da navegação autônoma proporcionada pelo NAV2 e da infraestrutura do ROS 2, pode ser programado para navegar de forma inteligente, otimizando rotas, evitando obstáculos e realizando entregas autônomas.

Em nosso projeto, essa sucessão de tecnologias cria uma base sólida para a automação e eficiência nas operações logísticas internas. A interação entre ROS 2, NAV2 e TurtleBot3 visa impulsionar a navegação autônoma de robôs de entrega de ferramentas, representando um avanço significativo na aplicação de tecnologias de ponta para melhorar as operações industriais. Essa documentação destaca a sinergia entre essas tecnologias, evidenciando como elas se combinam para criar uma solução integrada e eficaz para nossos objetivos de projeto.

### Tópicos e nós 

No contexto do ROS (Robot Operating System), os conceitos fundamentais de nós e tópicos desempenham papéis cruciais na comunicação e coordenação entre diferentes partes de um sistema robótico. Um "nó" no ROS é uma unidade computacional autônoma que executa uma tarefa específica, seja controlar um sensor, processar dados ou realizar ações físicas. Cada nó é um processo independente que se comunica com outros nós para trocar informações.

Os "tópicos" são canais de comunicação que facilitam a troca de dados entre os nós. Eles representam fluxos de informações unidirecionais, onde um nó pode publicar dados em um tópico e outros nós podem se inscrever para receber esses dados. Essa arquitetura baseada em tópicos permite uma comunicação eficiente e desacoplada entre os nós, contribuindo para a modularidade e flexibilidade do sistema.

Em resumo, no ROS, os "nós" são entidades autônomas que executam tarefas específicas, enquanto os "tópicos" são canais de comunicação que possibilitam a troca de dados entre esses nós. Essa abordagem facilita a construção de sistemas robóticos complexos, onde diferentes componentes podem operar de maneira independente e colaborativa por meio de uma estrutura de comunicação flexível e eficaz.

## Módulos

ESte projeto é dividido em 4 pacotes pacotes, que futuramente serão unidos em um só, mas que por hora representam separadamente o sistema de mapeamento e de navegação de acordo com o contexto onde está sendo implementado o robô ( Turtlebot3 ou Gazebo ). Todos os pacotes estão no mesmo workspace contido na pasta ```src/bridge```.

### Mapeamento (mapping_launch)

O workspace de mapeamento contém um launcher que inicia os pacotes: turtlebot3_teleop (navegação manual) e turtlebot3_cartographer (sistema de cartografia via sensores tal como o SLAM).

#### Execução

Para executá-lo, juntamente com as suas dependências, é preciso seguir as seguintes instruções:

- Na pasta raíz desse projeto rode o seguinte comando:

```
sudo chmod +x ./mapping_<turtlebot3/gazebo>_zsh.sh
```

> [!IMPORTANT]
> Verifique qual a versão do seu shell com o seguinte comando: ```echo $SHELL```, caso ela difira do tipo zsh rode o comando acima com o sufixo bash: ```sudo chmod +x ./mapping_<turtlebot3/gazebo>_bash.sh```. Se atente à escolha do ambiente ao rodar os comandos, por exemplo, caso vc queira rodar no ambiente simulado do gazebo, rode `sudo chmod +x ./mapping_gazebo_bash.sh`.

- Em seguida, no mesmo diretório rode o comando:

```
./mapping_<turtlebot3/gazebo>_zsh.sh
```

O script acima instalará na sua máquina todas as dependências necessárias para executar os nós ROS necessárias para a etapa de mapeamento.

> [!IMPORTANT]
> Mais uma vez verifique qual a versão do seu shell com o seguinte comando: ```echo $SHELL```, caso ela difira do tipo zsh rode o comando acima com o sufixo bash: ```./mapping_<turtlebot3/gazebo>_bash.sh```. Se atente à escolha do ambiente ao rodar os comandos, por exemplo, caso vc queira rodar no ambiente simulado do gazebo, rode `./mapping_gazebo_bash.sh`.

- Após isso, em outro terminal, é preciso rodar o comando abaixo para salvar o mapa gerado pela varredura no mapa:
  
```
ros2 run nav2_map_server map_saver_cli -f ./assets/map_<turtlebot3/gazebo>
```

Depois de obter sucesso com os comandos acima, você cumpriu a rotina de mapeamento. Agora basta clicar em CTRL+C para encerrar todos os processos criados pelo script `.sh`

### Navegação (nav_workspace)
O workspace de navegação contém um pacote com um script em bash que inicia o Rviz com um arquivo de mapa fornecido como argumento. Além disso, há cinco nós: um para abrir um terminal de chatbot, um para abrir um terminal de entrada de coordenadas, um nó para inicializar a pose do robô, e um nó para gerenciar a fila de pontos. O quinto nó, chamado Vallet, utiliza a API do Simple Commander para comunicação programática com o Nav2. As conexões entre esses tópicos podem ser visualizadas na imagem abaixo. Note que o nó de inicialização de pose não é visível porque ele se encerra assim que a pose é publicada, diferentemente dos outros, que permanecem ativos até o final da interação do usuário.

![Alt text](../../static/img/topic_graph.png)


#### Execução

Para executá-los é preciso seguir as seguintes instruções:

- Na pasta raíz desse projeto rode o seguinte comando:

```
sudo chmod +x ./navigation_<turtlebot3/gazebo>_zsh.sh
```

> [!IMPORTANT]
> Verifique qual a versão do seu shell com o seguinte comando: ```echo $SHELL```, caso ela difira do tipo zsh rode o comando acima com o sufixo bash: ```sudo chmod +x ./navigation_<turtlebot3/gazebo>_bash.sh```. Se atente à escolha do ambiente ao rodar os comandos, por exemplo, caso vc queira rodar no ambiente simulado do gazebo, rode `sudo chmod +x ./navigation_gazebo_bash.sh`.

- Em seguida, no mesmo diretório, rode o comando:

```
./navigation_<turtlebot3/gazebo>_zsh.sh
```

> [!IMPORTANT]
> Mais uma vez verifique qual a versão do seu shell com o seguinte comando: ```echo $SHELL```, caso ela difira do tipo zsh rode o comando acima com o sufixo bash: ```./navigation_<turtlebot3/gazebo>_bash.sh```. Se atente à escolha do ambiente ao rodar os comandos, por exemplo, caso vc queira rodar no ambiente simulado do gazebo, rode `sudo chmod +x ./navigation_gazebo_bash.sh`.

- Tanto através do chatbot quanto do terminal de coordenadas, é possível enviar pontos para o robô. Esses pontos são publicados no tópico chatbot_msgs como mensagens do tipo Pose. O nó de fila se inscreve nesse tópico, enfileira os pontos e aguarda o status do nó Vallet.

- Quando o nó Vallet está disponível, a fila publica o próximo ponto no tópico poses. O nó Vallet escuta esse tópico, envia uma ação de goToPose quando disponível e aguarda uma nova pose. Após a conclusão, o nó Vallet publica "Busy" no tópico status, indicando que está ocupado, e posteriormente, "Free" ao finalizar.

- Depois de obter sucesso com os comandos acima, você cumpriu a rotina de mapeamento. Agora basta clicar em CTRL+C para encerrar todos os processos criados pelo script `.sh`.

## Demo
<iframe width="560" height="315" src="https://youtube.com/embed/vT2ij1Ez19A" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen> </iframe>



# Transição da Simulação para Robô Real em Mapeamento e Navegação

A transição do ambiente de simulação para a execução em um robô real requer ajustes minuciosos nas configurações de lançamento e nos parâmetros de código para garantir a precisão da navegação autônoma. Este documento descreve as mudanças específicas implementadas para adaptar o mapeamento e a navegação do Turtlebot3 no ambiente Gazebo para o seu equivalente no mundo real.

### Configurações de Lançamento para Mapeamento

Para a simulação no Gazebo, o lançamento é realizado através do arquivo `mapping_gazebo.launch.py`, que configura o ambiente virtual e os parâmetros de simulação. A seguir, um trecho do arquivo de simulação:

```python
# mapping_gazebo.launch.py
gazebo_dir = get_package_share_directory('turtlebot3_gazebo')
...
PythonLaunchDescriptionSource(gazebo_dir + '/launch/turtlebot3_world.launch.py')
```

Comparativamente, para o Turtlebot3 real, o arquivo `mapping_turtlebot3.launch.py` faz referência ao pacote `turtlebot3_cartographer`, que se liga aos sensores físicos para o mapeamento preciso do ambiente. Aqui está um trecho correspondente:

```python
# mapping_turtlebot3.launch.py
cartographer_dir = get_package_share_directory('turtlebot3_cartographer')
...
PythonLaunchDescriptionSource(cartographer_dir + '/launch/cartographer.launch.py')
```

A diferença chave está no uso do pacote `turtlebot3_cartographer` no lugar de `turtlebot3_gazebo`, refletindo a necessidade de interagir com hardware real ao invés de uma simulação.

### Ajustes Finais e Testes

Antes de finalizar a transição, é crucial realizar uma série de testes para assegurar que o robô se comporta conforme o esperado no ambiente real. Testes de integração e de sistema validam as funções de mapeamento, localização e planejamento de rotas, enquanto a análise de desempenho ajuda a ajustar os parâmetros de navegação para otimizar a eficiência e a segurança.

A documentação e os fragmentos de código fornecidos devem ser usados como um guia para desenvolvedores ao adaptar projetos de robótica de simulações para aplicações do mundo real, assegurando que as transições sejam suaves e que o robô mantenha sua operacionalidade em novos ambientes.

### Conclusão

Em suma, a transição do simulado para o real envolve modificações na interface de usuário e no processamento de dados sensoriais. Por exemplo, enquanto a simulação pode utilizar parâmetros generalizados para detecção de obstáculos, o robô real deve ajustar esses parâmetros para refletir as características específicas de seus sensores e do ambiente operacional.

A conversão bem-sucedida de um sistema de simulação para aplicação em um robô autônomo real é crítica para o avanço da robótica prática. As alterações apresentadas garantem a integração harmoniosa entre o software de simulação e as as capacidades do robô físico. Este processo de adaptação não apenas reafirma a funcionalidade e a confiabilidade do sistema em ambientes reais, mas também destaca a importância da escalabilidade e flexibilidade do design do software.
